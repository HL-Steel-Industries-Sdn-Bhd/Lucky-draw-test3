<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>幸运转盘抽奖</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); padding: 20px; color: #333; }
.container { background-color: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); padding: 30px; width: 100%; max-width: 850px; text-align: center; overflow: hidden; position: relative; }
h1 { color: #2575fc; margin-bottom: 10px; font-size: 2.5rem; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1); }
.subtitle { color: #666; margin-bottom: 30px; font-size: 1.1rem; }
.wheel-container { position: relative; margin: 30px auto; width: 500px; height: 500px; }
#wheelCanvas { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 8px #fff, 0 0 30px rgba(0, 0, 0, 0.2); }
.pointer { position: absolute; top: 50%; left: 50%; width: 40px; height: 60px; z-index: 10; transform-origin: 50% 100%; }
.pointer::before { content: ''; position: absolute; width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 60px solid #ff4757; top: -60px; left: 0; transform: translateX(-50%); }
.center-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background-color: #000; border-radius: 50%; z-index: 5; display: none; }
.controls { margin: 30px 0; }
#spinButton { background-color: #ff6b81; color: white; border: none; padding: 16px 45px; font-size: 1.4rem; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 107, 129, 0.4); font-weight: bold; letter-spacing: 1px; margin-bottom: 25px; }
#spinButton:hover { background-color: #ff4757; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 107, 129, 0.6); }
#spinButton:active { transform: translateY(0); }
#spinButton.start { background-color: #ff6b81; }
#spinButton.stop { background-color: #3742fa; }
.result-container { background-color: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 20px; border-left: 5px solid #2575fc; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
#result { font-size: 1.8rem; font-weight: bold; color: #2575fc; min-height: 60px; display: flex; align-items: center; justify-content: center; }
.prize-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 30px; text-align: left; }
.prize-item { background-color: #f1f8ff; padding: 15px; border-radius: 10px; display: flex; align-items: center; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); }
.prize-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 15px; }
.status { margin-top: 20px; font-size: 0.9rem; color: #666; }
.spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
@keyframes spin { to { transform: rotate(360deg); } }
.spinning .spinner { display: inline-block; }
.hidden-frame { display: none; }
@media (max-width: 768px) { .wheel-container { width: 350px; height: 350px; } .container { padding: 20px; } h1 { font-size: 2rem; } .prize-info { grid-template-columns: 1fr; } }
@media (max-width: 480px) { .wheel-container { width: 280px; height: 280px; } }
</style>
</head>
<body>
<div class="container">
<h1><i class="fas fa-gift"></i> 幸运转盘抽奖</h1>
<p class="subtitle">点击开始按钮转动转盘，点击停止按钮停止转盘</p>
<div class="wheel-container">
<canvas id="wheelCanvas" width="500" height="500"></canvas>
<div class="pointer" id="pointer"></div>
<div class="center-marker" id="centerMarker"></div>
</div>
<div class="controls">
<button id="spinButton" class="start">
<span class="spinner"></span>
<span class="button-text">开始</span>
</button>
<div class="result-container">
<div id="result">等待抽奖...</div>
</div>
</div>
<div class="prize-info">
<div class="prize-item"><div class="prize-color" style="background-color: #FF6B8B;"></div><div>再来一次 (40%)</div></div>
<div class="prize-item"><div class="prize-color" style="background-color: #4ECDC4;"></div><div>二等奖 (20%)</div></div>
<div class="prize-item"><div class="prize-color" style="background-color: #FFD166;"></div><div>一等奖 (10%)</div></div>
<div class="prize-item"><div class="prize-color" style="background-color: #06D6A0;"></div><div>三等奖 (30%)</div></div>
</div>
<div class="status" id="status">就绪 - 点击开始按钮开始抽奖</div>
<iframe name="hiddenFrame" class="hidden-frame"></iframe>
<div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
<button id="debugBtn" style="padding: 5px 10px; font-size: 12px; background: #333; color: white; border: none; border-radius: 3px; cursor: pointer;">显示中心点</button>
</div>
</div>

<script>
const prizes = [
  { name: "再来一次", probability: 0.4, slices:[1,8], color:"#FF6B8B" },
  { name: "二等奖", probability: 0.2, slices:[9,12], color:"#4ECDC4" },
  { name: "三等奖", probability: 0.3, slices:[13,18], color:"#06D6A0" },
  { name: "一等奖", probability: 0.1, slices:[19,20], color:"#FFD166" }
];

let canvas = document.getElementById('wheelCanvas');
let ctx = canvas.getContext('2d');
let pointer = document.getElementById('pointer');
let spinButton = document.getElementById('spinButton');
let resultDisplay = document.getElementById('result');
let statusDisplay = document.getElementById('status');

let isSpinning=false, isDecelerating=false, spinSpeed=0, maxSpeed=15;
let currentRotation=0, targetPrizeIndex=-1, stopRotation=0;

function drawWheel(){
    const centerX=canvas.width/2, centerY=canvas.height/2, radius=Math.min(centerX,centerY)-10;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let startAngle=-Math.PI/2;
    prizes.forEach(prize=>{
        const angle=prize.probability*2*Math.PI;
        const endAngle=startAngle+angle;
        ctx.beginPath();
        ctx.moveTo(centerX,centerY);
        ctx.arc(centerX,centerY,radius,startAngle,endAngle);
        ctx.closePath();
        ctx.fillStyle=prize.color;
        ctx.fill();
        ctx.strokeStyle='#fff';
        ctx.lineWidth=2;
        ctx.stroke();
        // 文字
        ctx.save();
        ctx.translate(centerX,centerY);
        ctx.rotate(startAngle+angle/2);
        ctx.fillStyle='white';
        ctx.font='bold 18px Arial';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        ctx.fillText(prize.name,radius*0.7,0);
        ctx.font='16px Arial';
        ctx.fillText(`${(prize.probability*100).toFixed(0)}%`,radius*0.7,20);
        ctx.restore();
        startAngle=endAngle;
    });
}

function selectPrizeByProbability(){
    const rand=Math.random();
    let cum=0;
    for(let i=0;i<prizes.length;i++){
        cum+=prizes[i].probability;
        if(rand<=cum) return i;
    }
    return prizes.length-1;
}

// 计算奖项中心角度(指针指向)
function getPrizeCenterAngle(index){
    const slices=prizes[index].slices;
    const centerSlice=Math.floor((slices[0]+slices[1])/2);
    return centerSlice*18-9; // 每份18°，减半对准中心
}

// 指针旋转更新
function updatePointer(){
    pointer.style.transform=`rotate(${currentRotation}deg)`;
}

function startSpin(){
    if(isSpinning) return;
    isSpinning=true;
    isDecelerating=false;
    spinButton.classList.add('spinning');
    spinButton.classList.remove('start');
    spinButton.classList.add('stop');
    spinButton.querySelector('.button-text').textContent='停止';
    statusDisplay.textContent='指针加速旋转中...';
    resultDisplay.textContent='等待结果...';
    targetPrizeIndex = selectPrizeByProbability();
    spinSpeed=0;
    let lastTime=Date.now();

    function accelerate(){
        if(!isSpinning) return;
        const now=Date.now();
        const dt=now-lastTime;
        lastTime=now;
        spinSpeed+=0.02*dt;
        if(spinSpeed>=maxSpeed){
            spinSpeed=maxSpeed;
            isDecelerating=true;
            statusDisplay.textContent='指针全速旋转中，点击停止按钮...';
            return;
        }
        currentRotation=(currentRotation+spinSpeed)%360;
        updatePointer();
        animationId=requestAnimationFrame(accelerate);
    }
    animationId=requestAnimationFrame(accelerate);
}

function stopSpin(){
    if(!isSpinning || !isDecelerating) return;
    const targetAngle=getPrizeCenterAngle(targetPrizeIndex);
    let rotationNeeded=targetAngle-(currentRotation%360);
    if(rotationNeeded<0) rotationNeeded+=360;
    rotationNeeded+=360*5; // 多转5圈
    stopRotation=currentRotation+rotationNeeded;

    let lastTime=Date.now();
    function decelerate(){
        const now=Date.now();
        const dt=now-lastTime;
        lastTime=now;
        const remaining=stopRotation-currentRotation;
        const deceleration=spinSpeed*spinSpeed/(2*remaining);
        spinSpeed-=deceleration*dt/16;
        if(spinSpeed<=0 || remaining<=0.5){
            spinSpeed=0;
            currentRotation=stopRotation;
            updatePointer();
            finishSpin();
            return;
        }
        currentRotation+=spinSpeed;
        updatePointer();
        animationId=requestAnimationFrame(decelerate);
    }
    animationId=requestAnimationFrame(decelerate);
    statusDisplay.textContent='指针减速中...';
}

function finishSpin(){
    isSpinning=false;
    isDecelerating=false;
    const prize=prizes[targetPrizeIndex];
    resultDisplay.textContent=`恭喜！您获得了：${prize.name}！`;
    resultDisplay.style.color=prize.color;
    spinButton.classList.remove('spinning');
    spinButton.classList.remove('stop');
    spinButton.classList.add('start');
    spinButton.querySelector('.button-text').textContent='开始';
    statusDisplay.textContent='抽奖完成，奖品已记录到Google Sheets';
    submitToGoogleSheets(prize.name);
}

function submitToGoogleSheets(prize){
    const timestamp=new Date().toISOString();
    const scriptUrl='https://script.google.com/macros/s/AKfycbw9sCZV_blJ_VQH7np29a7B6JfIV80vN5RL2ucVVpKrsJ9r8FrxouNNWBLSeUUqfzAL/exec';
    const form=document.createElement('form');
    form.method='POST';
    form.action=scriptUrl;
    form.target='hiddenFrame';
    const timestampField=document.createElement('input');
    timestampField.type='hidden';
    timestampField.name='timestamp';
    timestampField.value=timestamp;
    form.appendChild(timestampField);
    const prizeField=document.createElement('input');
    prizeField.type='hidden';
    prizeField.name='prize';
    prizeField.value=prize;
    form.appendChild(prizeField);
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    console.log(`提交到Google Sheets: ${timestamp} - ${prize}`);
}

spinButton.addEventListener('click',()=>{
    if(!isSpinning) startSpin();
    else if(isDecelerating) stopSpin();
});

const debugBtn=document.getElementById('debugBtn');
const centerMarker=document.getElementById('centerMarker');
debugBtn.addEventListener('click',()=>{ centerMarker.style.display=centerMarker.style.display==='block'?'none':'block'; });

window.addEventListener('load',()=>{
    drawWheel();
    updatePointer();
    statusDisplay.textContent='就绪 - 点击开始按钮开始抽奖';
    function resizeCanvas(){
        const container=document.querySelector('.wheel-container');
        const size=Math.min(container.offsetWidth,container.offsetHeight);
        canvas.width=size;
        canvas.height=size;
        drawWheel();
        updatePointer();
    }
    resizeCanvas();
    window.addEventListener('resize',resizeCanvas);
});
</script>
</body>
</html>
